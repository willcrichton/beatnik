BeatDetektor=undefined;Beatnik=function(a,b,c){function h(a){var b=a.inputBuffer.getChannelData(0);var c=a.inputBuffer.getChannelData(1);var h=a.outputBuffer.getChannelData(0);var j=a.outputBuffer.getChannelData(1);var k=b.length;for(var l=0;l<k;++l){h[l]=b[l];j[l]=c[l]}var n=new Uint8Array(m.frequencyBinCount);m.getByteFrequencyData(n);d.process(i.currentTime,b);e.process(d);f.process(d);var o=0;for(var l=0;l<80;l++)o+=f.getLevel(l);o/=80;g.callback(n,e.isKick(),o,a.outputBuffer)}var d=new BeatDetektor(50,199);var e=new BeatDetektor.modules.vis.BassKick;var f=new BeatDetektor.modules.vis.VU;var g=this;this.callback=b||function(){};var i=new webkitAudioContext;var j=i.createBufferSource();var k=i.createGainNode();var l=i.createJavaScriptNode(2048);l.onaudioprocess=h;var m=i.createAnalyser();m.fftSize=2048;m.smoothingTimeConstant=.75;j.connect(k);k.connect(l);l.connect(m);m.connect(i.destination);this.context=i;this.source=j;this.volume=k;var n=new XMLHttpRequest;n.open("GET",a,true);n.responseType="arraybuffer";n.onload=function(){j.buffer=i.createBuffer(n.response,false);j.loop=false;if(c)c()};this.load=function(){n.send()};this.play=function(){console.log("Playing...");j.noteOn(i.currentTime+1)};this.pause=function(){console.log("Pausing...");j.noteOff(i.currentTime)};this.getDuration=function(){return j.buffer.duration};this.getPosition=function(){return i.currentTime};this.setSpeed=function(a){j.playbackRate.value=a};this.setVolume=function(a){k.gain.value=a};this.spatialize=function(){var a=i.createPanner();a.listener=i.listener;k.disconnect();k.connect(a);a.connect(l)};this.addImpulseEffect=function(a){var b=i.createConvolver();k.disconnect();k.connect(b);b.connect(l);var c=new XMLHttpRequest;c.open("GET",a);c.responseType="arraybuffer";c.onload=function(){b.buffer=i.createBuffer(c.response,false)};c.send()};this.set3DPosition=function(a,b,c){this.spatializer.setPosition(a,b,c)};this.set3DVelocity=function(a,b,c){this.spatializer.setPosition(a,b,c)}};BeatDetektor=function(a,b,c){if(typeof a=="undefined")a=85;if(typeof b=="undefined")b=169;this.config=typeof c!="undefined"?c:BeatDetektor.config;this.BPM_MIN=a;this.BPM_MAX=b;this.beat_counter=0;this.half_counter=0;this.quarter_counter=0;this.a_freq_range=new Array(this.config.BD_DETECTION_RANGES);this.ma_freq_range=new Array(this.config.BD_DETECTION_RANGES);this.maa_freq_range=new Array(this.config.BD_DETECTION_RANGES);this.last_detection=new Array(this.config.BD_DETECTION_RANGES);this.ma_bpm_range=new Array(this.config.BD_DETECTION_RANGES);this.maa_bpm_range=new Array(this.config.BD_DETECTION_RANGES);this.detection_quality=new Array(this.config.BD_DETECTION_RANGES);this.detection=new Array(this.config.BD_DETECTION_RANGES);this.reset();if(typeof console!="undefined"){};};BeatDetektor.prototype.reset=function(){for(var a=0;a<this.config.BD_DETECTION_RANGES;a++){this.a_freq_range[a]=0;this.ma_freq_range[a]=0;this.maa_freq_range[a]=0;this.last_detection[a]=0;this.ma_bpm_range[a]=this.maa_bpm_range[a]=60/this.BPM_MIN+(60/this.BPM_MAX-60/this.BPM_MIN)*(a/this.config.BD_DETECTION_RANGES);this.detection_quality[a]=0;this.detection[a]=false}this.ma_quality_avg=0;this.ma_quality_total=0;this.bpm_contest=new Array;this.bpm_contest_lo=new Array;this.quality_total=0;this.quality_avg=0;this.current_bpm=0;this.current_bpm_lo=0;this.winning_bpm=0;this.win_val=0;this.winning_bpm_lo=0;this.win_val_lo=0;this.win_bpm_int=0;this.win_bpm_int_lo=0;this.bpm_predict=0;this.is_erratic=false;this.bpm_offset=0;this.last_timer=0;this.last_update=0;this.bpm_timer=0;this.beat_counter=0;this.half_counter=0;this.quarter_counter=0};BeatDetektor.config_default={BD_DETECTION_RANGES:128,BD_DETECTION_RATE:12,BD_DETECTION_FACTOR:.915,BD_QUALITY_DECAY:.6,BD_QUALITY_TOLERANCE:.96,BD_QUALITY_REWARD:10,BD_QUALITY_STEP:.1,BD_MINIMUM_CONTRIBUTIONS:6,BD_FINISH_LINE:60,BD_REWARD_TOLERANCES:[.001,.005,.01,.02,.04,.08,.1,.15,.3],BD_REWARD_MULTIPLIERS:[20,10,8,1,1/2,1/4,1/8,1/16,1/32]};BeatDetektor.config=BeatDetektor.config_default;BeatDetektor.prototype.process=function(a,b){if(!this.last_timer){this.last_timer=a;return}if(this.last_timer>a){this.reset();return}var c=a;this.last_update=a-this.last_timer;this.last_timer=a;if(this.last_update>1){this.reset();return}var d,e;var f;var g=60/this.BPM_MAX;var h=60/this.BPM_MIN;var i=b.length/this.config.BD_DETECTION_RANGES;var j=0;for(e=0;e<b.length;e+=i){this.a_freq_range[j]=0;for(d=e;d<e+i;d++){f=Math.abs(b[d]);this.a_freq_range[j]+=f}this.a_freq_range[j]/=i;this.ma_freq_range[j]-=(this.ma_freq_range[j]-this.a_freq_range[j])*this.last_update*this.config.BD_DETECTION_RATE;this.maa_freq_range[j]-=(this.maa_freq_range[j]-this.ma_freq_range[j])*this.last_update*this.config.BD_DETECTION_RATE;var k=this.ma_freq_range[j]*this.config.BD_DETECTION_FACTOR>=this.maa_freq_range[j];if(this.ma_bpm_range[j]>h)this.ma_bpm_range[j]=h;if(this.ma_bpm_range[j]<g)this.ma_bpm_range[j]=g;if(this.maa_bpm_range[j]>h)this.maa_bpm_range[j]=h;if(this.maa_bpm_range[j]<g)this.maa_bpm_range[j]=g;var l=false;if(!this.detection[j]&&k){var m=c-this.last_detection[j];if(m<h&&m>g){for(d=0;d<this.config.BD_REWARD_TOLERANCES.length;d++){if(Math.abs(this.ma_bpm_range[j]-m)<this.ma_bpm_range[j]*this.config.BD_REWARD_TOLERANCES[d]){this.detection_quality[j]+=this.config.BD_QUALITY_REWARD*this.config.BD_REWARD_MULTIPLIERS[d];l=true}}if(l){this.last_detection[j]=c}}else if(m>=h){m/=2;if(m<h&&m>g)for(d=0;d<this.config.BD_REWARD_TOLERANCES.length;d++){if(Math.abs(this.ma_bpm_range[j]-m)<this.ma_bpm_range[j]*this.config.BD_REWARD_TOLERANCES[d]){this.detection_quality[j]+=this.config.BD_QUALITY_REWARD*this.config.BD_REWARD_MULTIPLIERS[d];l=true}}if(!l){m*=2}this.last_detection[j]=c}if(l){var n=this.detection_quality[j]/this.quality_avg*this.config.BD_QUALITY_STEP;if(n>1){n=1}this.ma_bpm_range[j]-=(this.ma_bpm_range[j]-m)*n;this.maa_bpm_range[j]-=(this.maa_bpm_range[j]-this.ma_bpm_range[j])*n}else if(m>=g&&m<=h){if(this.detection_quality[j]<this.quality_avg*this.config.BD_QUALITY_TOLERANCE&&this.current_bpm){this.ma_bpm_range[j]-=(this.ma_bpm_range[j]-m)*this.config.BD_QUALITY_STEP;this.maa_bpm_range[j]-=(this.maa_bpm_range[j]-this.ma_bpm_range[j])*this.config.BD_QUALITY_STEP}this.detection_quality[j]-=this.config.BD_QUALITY_STEP}else if(m>=h){if(this.detection_quality[j]<this.quality_avg*this.config.BD_QUALITY_TOLERANCE&&this.current_bpm){this.ma_bpm_range[j]-=(this.ma_bpm_range[j]-this.current_bpm)*.5;this.maa_bpm_range[j]-=(this.maa_bpm_range[j]-this.ma_bpm_range[j])*.5}this.detection_quality[j]-=this.config.BD_QUALITY_STEP}}if(!l&&c-this.last_detection[j]>h||k&&Math.abs(this.ma_bpm_range[j]-this.current_bpm)>this.bpm_offset)this.detection_quality[j]-=this.detection_quality[j]*this.config.BD_QUALITY_STEP*this.config.BD_QUALITY_DECAY*this.last_update;if(this.detection_quality[j]<.001)this.detection_quality[j]=.001;this.detection[j]=k;j++}this.quality_total=0;var o=0;var p=0;for(var e=0;e<this.config.BD_DETECTION_RANGES;e++){this.quality_total+=this.detection_quality[e]}this.quality_avg=this.quality_total/this.config.BD_DETECTION_RANGES;if(this.quality_total){this.ma_quality_avg+=(this.quality_avg-this.ma_quality_avg)*this.last_update*this.config.BD_DETECTION_RATE/2;this.maa_quality_avg+=(this.ma_quality_avg-this.maa_quality_avg)*this.last_update;this.ma_quality_total+=(this.quality_total-this.ma_quality_total)*this.last_update*this.config.BD_DETECTION_RATE/2;this.ma_quality_avg-=.98*this.ma_quality_avg*this.last_update*3}else{this.quality_avg=.001}if(this.ma_quality_total<=0)this.ma_quality_total=.001;if(this.ma_quality_avg<=0)this.ma_quality_avg=.001;var q=0;var r=this.current_bpm;var s=new Array;if(this.quality_avg)for(e=0;e<this.config.BD_DETECTION_RANGES;e++){if(this.detection_quality[e]*this.config.BD_QUALITY_TOLERANCE>=this.ma_quality_avg){if(this.ma_bpm_range[e]<h&&this.ma_bpm_range[e]>g){o+=this.maa_bpm_range[e];var t=Math.round(60/this.maa_bpm_range[e]*1e3);t=Math.abs(Math.ceil(t)-60/this.current_bpm*1e3)<Math.abs(Math.floor(t)-60/this.current_bpm*1e3)?Math.ceil(t/10):Math.floor(t/10);var u=parseInt(t/10);if(typeof (s[u]=="undefined"))s[u]=0;s[u]+=this.detection_quality[e]/this.quality_avg;p++;if(r==0)r=this.maa_bpm_range[e];else{q+=Math.abs(r-this.maa_bpm_range[e])}}}}var v=p>=this.config.BD_MINIMUM_CONTRIBUTIONS?true:false;var w=0;var x=0;if(v){for(var y in s){if(s[y]>x){x=s[y];w=y}}this.bpm_predict=60/(w/10);q/=p;this.bpm_offset=q;if(!this.current_bpm){this.current_bpm=this.bpm_predict}}if(this.current_bpm&&this.bpm_predict)this.current_bpm-=(this.current_bpm-this.bpm_predict)*this.last_update;var z=0;for(var A in this.bpm_contest){if(z<this.bpm_contest[A])z=this.bpm_contest[A];if(this.bpm_contest[A]>this.config.BD_FINISH_LINE/2){var B=parseInt(Math.round(A/10));if(this.bpm_contest_lo[B]!=this.bpm_contest_lo[B])this.bpm_contest_lo[B]=0;this.bpm_contest_lo[B]+=this.bpm_contest[A]/6*this.last_update}}if(z>this.config.BD_FINISH_LINE){for(var A in this.bpm_contest){this.bpm_contest[A]=this.bpm_contest[A]/z*this.config.BD_FINISH_LINE}}z=0;for(var A in this.bpm_contest_lo){if(z<this.bpm_contest_lo[A])z=this.bpm_contest_lo[A]}if(z>this.config.BD_FINISH_LINE){for(var A in this.bpm_contest_lo){this.bpm_contest_lo[A]=this.bpm_contest_lo[A]/z*this.config.BD_FINISH_LINE}}for(A in this.bpm_contest){this.bpm_contest[A]-=this.bpm_contest[A]*(this.last_update/this.config.BD_DETECTION_RATE)}for(A in this.bpm_contest_lo){this.bpm_contest_lo[A]-=this.bpm_contest_lo[A]*(this.last_update/this.config.BD_DETECTION_RATE)}this.bpm_timer+=this.last_update;var C=0;var D=0;if(this.bpm_timer>this.winning_bpm/4&&this.current_bpm){this.win_val=0;this.win_val_lo=0;if(this.winning_bpm)while(this.bpm_timer>this.winning_bpm/4)this.bpm_timer-=this.winning_bpm/4;this.quarter_counter++;this.half_counter=parseInt(this.quarter_counter/2);this.beat_counter=parseInt(this.quarter_counter/4);var E=parseInt(Math.round(60/this.current_bpm*10));if(typeof this.bpm_contest[E]=="undefined")this.bpm_contest[E]=0;this.bpm_contest[E]+=this.config.BD_QUALITY_REWARD;for(var A in this.bpm_contest){if(this.win_val<this.bpm_contest[A]){C=A;this.win_val=this.bpm_contest[A]}}if(C){this.win_bpm_int=parseInt(C);this.winning_bpm=60/(C/10)}for(var A in this.bpm_contest_lo){if(this.win_val_lo<this.bpm_contest_lo[A]){D=A;this.win_val_lo=this.bpm_contest_lo[A]}}if(D){this.win_bpm_int_lo=parseInt(D);this.winning_bpm_lo=60/D}}};BeatDetektor.modules=new Object;BeatDetektor.modules.vis=new Object;BeatDetektor.modules.vis.BassKick=function(){this.is_kick=false};BeatDetektor.modules.vis.BassKick.prototype.process=function(a){this.is_kick=a.detection[0]&&a.detection[1]};BeatDetektor.modules.vis.BassKick.prototype.isKick=function(){return this.is_kick};BeatDetektor.modules.vis.VU=function(){this.vu_levels=new Array};BeatDetektor.modules.vis.VU.prototype.process=function(a,b){var c,d,e=0;if(typeof b=="undefined")b=a.last_update;for(c=0;c<a.config.BD_DETECTION_RANGES;c++){d=a.ma_freq_range[c]/a.maa_freq_range[c];if(d>e)e=d}if(e<=0)e=1;for(c=0;c<a.config.BD_DETECTION_RANGES;c++){d=a.ma_freq_range[c]/a.maa_freq_range[c];if(d!=d)d=0;if(d>1){d-=1;if(d>1)d=1;if(d>this.vu_levels[c])this.vu_levels[c]=d;else if(a.current_bpm)this.vu_levels[c]-=(this.vu_levels[c]-d)*b*(1/a.current_bpm)*3}else{if(a.current_bpm)this.vu_levels[c]-=b/a.current_bpm*2}if(this.vu_levels[c]<0||this.vu_levels[c]!=this.vu_levels[c])this.vu_levels[c]=0}};BeatDetektor.modules.vis.VU.prototype.getLevel=function(a){return this.vu_levels[a]}